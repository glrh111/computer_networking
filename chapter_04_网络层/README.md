## 4.1 概述

### 4.1.1 转发和路由选择

网络层的作用，将packet从一台发送主机，移动到一台接收主机，为此，需要两种重要的网络层功能：
+ 转发forwarding：当一个packet到达路由器的一条输入链路时，路由器必须将该packet移动到适当的输出链路。
+ 路由选择routing：当packet从发送方流向接收方时，网络层必须决定这些packet所采用的路由或者路径。计算这些路径的算法被称为路由选择算法routing algorithm
+ 建立连接 connection setup : 网络层体系结构，如ATM，帧中继，MPLS，要求从源到目的地沿着所选择的路径彼此握手。。。

转发是指将packet从一个输入链路接口移动到适当的输出链路接口的路由器本地动作。路由选择是指网络范围的过程，以决定packet从源到目的地所采取的端到端的路径。

每台路由器有一张转发表forwarding table, 路由器通过检查到达packet的首部字段的值来转发packet，然后使用该值在该路由器的转发表中索引查询。

路由选择算法决定了插入路由器的转发表中的值。路由选择算法可以是集中式的，也可以是分布式的。路由器接收路由选择协议报文，该信息被用于配置其转发表。

分组交换机：一台通用交换设备，它根据分组首部字段的值，从输入链路接口到输出链路接口转移packet。
+ 链路层交换机 link-layer switches：基于链路层中的值做转发决定
+ 路由器 router：基于网络层字段的值做转发决定

### 4.1.2 网络服务模型 network service model

定义了packet在发送与接收端系统之间的端到端运输特性。

网络体系结构|服务模型|带宽保证|无丢包保证|有序|定时|拥塞指示
---|---|---|---|---|---|---
因特网|尽力而为|无|无|任何可能的顺序|不维护|无
ATM|CBR|保证恒定速率|是|有序|维护|不出现拥塞
ATM|ABR|保证最小速率|无|有序|不维护|提供拥塞指示

ATM Asynchronous Transfer Mode 异步传输模式，信元中继。

+ CBR Constant Bit Rate ATM网络服务
+ ABR Available Bit Rate ATM网络服务 与因特网不同的是，cell不会被重新排序

## 4.2 虚电路和数据报网络

网络层与传输层类似，也提供无连接服务和连接服务。两层的主要差异如下：
+ 网络层向传输层提供主机到主机的服务，而在传输层中，这些服务是向应用层提供的进程到进程的服务
+ 特定的计算机网络（因特网、ATM、帧中继）不能同时提供无连接服务和连接服务
  + 仅在网络层提供连接服务的计算机网络称为虚电路Virtual-Circuit网络
  + 仅在网络层提供无连接服务的计算机网络称为数据报网络 datagram network
+ 在传输层实现的面向连接的服务与在网络层实现的连接服务是根本不同的。网络层的连接服务不仅在端系统中实现，也在网络核心的路由器中实现。

### 4.2.1 虚电路网络

一条虚电路，就是某些网络在网络层的连接，组成如下
+ 源和目的主机之间的一条路径，即一系列链路和路由器
+ VC号，沿着该路径的每段链路的一个号码
+ 沿着该链路的每台路由器中的转发表表项

无论何时跨越一台路由器创建一条新的虚电路，转发表就增加一个新表项。

虚电路有三个阶段
+ 虚电路建立：传输层与网络层联系，制定接收方地址，等待网络建立虚电路。
  + 网络层决定发送方与接收方之间的路径
  + 为沿着该路径的而所有链路确定一个VC号码。
  + 网络层在沿着路径的每台路由器的转发表中增加一个表项
  + 预留虚电路路径上的资源
+ 数据传送
+ 虚电路拆除：发送方通知网络层终止虚电路。更新路径上每一台路由器的转发表。

启动与终止虚电路的报文称为信令报文signaling message, 用来交换这些报文的协议称为信令协议signaling protocol.

### 4.2.2 数据报网络

每当一个packet到达路由器时，会根据该路由器的转发表匹配目的地址的前缀，根据最大前缀匹配原则将该packet送往匹配的输出链路。

### 4.2.3 虚电路和数据报网络的由来

+ 虚电路的概念来自电话界，采用了真正的电路。
+ 因特网连接的端系统比较复杂，所以使网络层服务模型尽可能简单，另外的功能在更高的层次实现

这么设计导致了很有趣的结果
+ 因特网网络模型保证最少，导致可以使用各种不同的链路层技术：卫星，光纤，无线等
+ 新增网络服务，只需要在网络中接入一个主机提供服务即可


## 4.3 路由器工作原理

![路由器体系结构](http://o9hjg7h8u.bkt.clouddn.com/%E8%B7%AF%E7%94%B1%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png)

+ 输入端口：物理链路与路由器相连的物理层功能；链路层功能；通过查询路由选择处理器决定输出端口
+ 交换结构：将输入实处端口相连，这种交换结构完全包含在路由器中，它是一个网络路由器中的网络。
+ 输出端口：存储从交换结构接收的packet，并执行必要的链路层和物理层功能
+ 路由选择处理器：执行路由选择协议，维护路由表和连接的链路状态信息，并未路由器计算转发表。并且执行网络管理功能。

路由器转发平面 router forwarding plane 一台路由器的输入端口，输出端口，和交换结构共同实现了转发功能，并且总是用硬件实现，以ns尺度运行（远快过硬件实现的速率）。

路由器控制平面 router control plane 在毫秒或秒尺度上运行，通常用软件实现，并在路由选择处理器上执行。

### 4.3.1 输入端口

![输入端口处理](http://o9hjg7h8u.bkt.clouddn.com/4-7%E8%BE%93%E5%85%A5%E7%AB%AF%E5%8F%A3%E5%A4%84%E7%90%86.png)

转发表由路由选择处理器计算并更新，而且会复制到每个端口中（上上图虚线），这样每次转发时，不需要调用处理器。

由于转发速度限制，查找必须在纳秒级执行，因此，不仅必须要用硬件进行查找，而且需要对大型转发表使用超出简单线性搜索的技术；
同时必须给于内存访问时间以特别关注，这导致用嵌入式片上DRAM和更快的SRAM内存来设计。
三态可寻址存储器 Tenary Content Address Memory 也经常被用于查找。

通过查找确认某packet的输出端口后，packet即可进入交换结构。

输入端口的其他动作：
+ 物理层和链路层处理
+ 检查packet的版本号，校验和以及寿命字段，并且重写后两个字段
+ 更新用于网络管理的计数器

### 4.3.2 交换结构

![三种交换技术](http://o9hjg7h8u.bkt.clouddn.com/4-8.%E4%B8%89%E7%A7%8D%E4%BA%A4%E6%8D%A2%E6%8A%80%E6%9C%AF.png)

#### 1 经内存交换

最简单，最早的路由器是传统计算机。交换是在CPU控制下完成的。

Cisco Catalyst 8500

#### 2 经总线交换

输入输出端口经过一根共享总线传送packet。

输入端口为packet预先设置交换机内部标签，指示输出端口，该packet将发送到所有的输出端口上，但只有匹配的输出端口才会处理它。

一次只有一个packet能跨过总线。

Cisco 5600

#### 3 经互联网络交换

纵横式交换机，是一种由2N条总线组成的互联网络，连接N个输入端口与N个输出端口。交叉点通过交换结构控制器能够在任何时候开启或者闭合。

Cisco 12000

### 4.3.3 输出端口

输出端口处理取出存放在输出端口内存中的packet将其发送到输出链路上。

### 4.3.4 何处出现排队

输入输出端口都可能出现排队现象，但是交换机构的处理速度一般非常快，远快于链路传输速度，故只讨论输出端口的排队情况。

输出端口排队的后果就是，在输出端口上的一个分组调度程序packet scheduler，必须在这些排队的packet中选出几个来发送。
+ 简单的：FCFS 先来先服务
+ 复杂点的额：WFQ 加权公平排队 在不同端到端连接上公平地共享输出链路。

分组调度程序在提供服务质量保证quality-of-service guarantee方面起着关键作用。


如果没有足够内存来缓存入分组，那么必须丢弃到达的packet （弃尾drop tail），或者删除一个或多个已经排队的packet来腾出空间。

在某些情况下，可以在缓存填满前丢弃一个packet来为发送方提供拥塞信号。



### 4.3.5 路由器选择控制平面



## 4.4 网际协议：因特网中的转发和编址


因特网编址和转发是IP的重要组件。

![因特网网络层的内部视图](http://o9hjg7h8u.bkt.clouddn.com/4-12%E5%9B%A0%E7%89%B9%E7%BD%91%E7%BD%91%E7%BB%9C%E5%B1%82%E7%9A%84%E5%86%85%E9%83%A8%E8%A7%86%E5%9B%BE.png)

网络层的三个主要组件
+ IP协议
+ 路由选择 决定了数据报从源到目的地所流经的路径
+ 报告数据报中的差错和对某些网络层信息请求进行响应的设施 ICMP

### 4.4.1 数据报格式

![IPv4数据报格式](http://o9hjg7h8u.bkt.clouddn.com/IPv4%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)

关键字段说明：
+ 版本号：4bit规定了IP协议版本，通过查看版本号，路由器能够确定如何解释IP数据报的剩余部分。（ipv4 为4）
+ 首部长度：因为IPv4数据报可能包含一些可变长度的选项，都包含在首部中，故需要此确定数据从哪里开始。大多数数据报不包含选项，默认20字节. (单位为32位字长，最小是5)
+ 服务类型：TOS 使不同类型的数据报能够相互区分开来。如将实时数据报（IP电话应用），非实时流量（FTP）
+ 数据报长度：首部+数据的总长度，Byte。16bit长度标识。所以IP数据报理论最大长度为65535字节，但是数据报很少有超过1500byte的。
+ 标识，标志，片偏移：与IP分片有关，IPv6不允许在路由器对packet分片。
+ 寿命：Time-To-Live 同来确保数据不会永远在网络中循环。每当数据报通过一台路由器处理，该字段值-1，若减为0，则数据报被丢弃。
+ 协议：该字段指示IP数据报的数据部分应交给哪个特定的传输层协议。6标识TCP，17标识UDP.
协议号（将网络层和传输层粘合在一起）所起的作用，与端口号（将传输层和应用层绑定在一起）相似，链路层帧也有类似的字段。
+ 首部校验和：只对IP首部计算校验和，并且每次通过路由器，都需要重新计算，因为TTL会发生变化。为什么网络层和传输层都需要计算校验和？
  + TCP也能使用在ATM上，IP也不一定携带TCP数据
  + IP只计算了首部的校验和
+ 源和目的IP地址
+ 选项 IPv6首部已经去掉了选项
+ 数据（有效载荷）：也可承载诸如ICMP报文

IP数据报分片

并不是所有的链路层协议，都能承载相同长度的网络层packet，以太网帧能够承载不超过1500byte的数据，某些广域网链路的帧可承载不超过576byte的数据。

一个链路层帧能够承载的最大数据量叫最大传送单元Maximum Transmission Unit MTU. 

IPv4将数据报datagram的重新组装工作放在端系统中，而不是放在路由器中，以此来保持网络内核简单。

分片的开销：
+ 使路由器和端系统更为复杂
+ 能够用于生成致命的DoS攻击

### 4.4.2 IPv4编址

主机与路由器连入网络的方法：
+ 一台主机通常只有一条链路连接到网络，当主机中的IP想发送数据报时，它就在该链路上发送。主机与物理链路之间的边界叫做接口interface。
+ 路由器有两条或更多链路与其连接。

IP要求，每台主机和路由器接口都由自己的IP地址，因此，一个IP技术上是与一个接口相关联的，而不是与包括该接口的主机或路由器相关联。

#### 1 IP地址

IPv4地址长度32bit，所以约有40亿个IPv4地址。

地址采用点分十进制记法dotted-decimal notation表示，每8个bit用一个等价的十进制书写，用点号隔开。

一个接口的IP地址的一部分需要由其所在的子网决定。

一个路由器连接的若干台机器，被称为子网subnet RFC950. 
为了确定子网，分开主机和路由器的每个接口，产生几个隔离的网络岛，使用接口端接这些隔离的网络的端点。这些隔离的网络中，每一个都叫做一个子网subnet.

IP编址为子网分配了一个地址，233.1.1.0/24 也称为子网掩码network mask，指示了32bit中的左侧24bit
定义了子网地址。 

![三台路由器互联六个子网](http://o9hjg7h8u.bkt.clouddn.com/4-17%E4%B8%89%E5%8F%B0%E8%B7%AF%E7%94%B1%E5%99%A8%E4%BA%92%E8%81%946%E4%B8%AA%E5%AD%90%E7%BD%91.png)

因特网地址分配策略称为:无类别域间路由选择 Classless Interdomain Routing CIDR RFC 4632

a.b.c.d/x 因特网的BGP路由选择协议，只考虑IP的前x比特，只转发到该子网。地址的剩余32-x bit可用于区分该组织内部设备。

CIDR被采用之前，IP地址的网络部分，被限制为长度为8\16\24bit，称为一种分类编址classful addressing。分别被称为A,B,C类网络。
但是该方案C类网络能容纳2^8-2=254台主机，太少；B类网络能容纳2^16-2=65534台主机，对许多机构太多，灵活性不够。

`ping -b 255.255.255.255`

IP广播地址，255.255.255.255 ，当一台主机，向目的地址为广播地址发送数据报时，该报文会交付给同一台网络中的所有主机。

#### 2 获取一块地址

从ISP获取一块地址。

ISP从ICANN Internet Corporation for Assigned Names and Numbers 管理规则 RFC2050
+ 分配IP地址
+ 管理DNS根服务器
+ 分配域名与解决域名纷争

ICANN向区域性因特网注册地址分配地址，。。。

#### 3 获取主机地址：动态主机配置协议DHCP

Dynamic Host Configuration DHCP RFC2131

主机地址可以手工分配，更多通多DHCP自动分配。DHCP还通知其他信息，子网掩码，默认网关（第一跳路由器地址），本地DNS地址。

DHCP的这种能将主机连接进一个网络的网络相关自动能力，被称为即插即用协议plug-and-play protocol

还可以同来节约IP地址。用户下线之后，更新可分配的IP地址池。

![DHCP客户服务器交互](http://o9hjg7h8u.bkt.clouddn.com/4-21DHCP%E5%AE%A2%E6%88%B7-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BA%A4%E4%BA%92.png)

+ DHCP服务器发现：一台新到的主机，向广播地址，使用UDP向68端口发送DHCP发现报文DHCP discover message.
+ DHCP服务器提供：DHCP向广播地址回复DHCP提供报文DHCP offer message ,子网中可能有几个DHCP服务器。该相应里边有向客户提供的IP地址、mask和IP地址租用期等。
+ DHCP请求：客户选择一个服务器，发送DHCP请求报文DHCP request message, 回显配置参数
+ DHCP ACK：使用DHCP ACK报文相应DHCP request message，证实所要求的参数。

DHCP还提供了一种机制允许客户更新它对一个IP地址的租用。

DHCP缺点：
+ IP地址会发生变化，不能维持TCP连接

移动IP允许用户在移动时，使用单一永久的地址。

#### 4 网络地址转换NAT

网络地址转换 Network Address Translation NAT

![NAT网络地址转换](http://o9hjg7h8u.bkt.clouddn.com/4-2NAT.png)

RFC1918规定了若干专用IP地址，只有在特定的子网中才有意义。

NAT路由器对外界的行为，如同具有单一IP的单一设备。

NAT路由器上有一张NAT translation table转换表，并且在表项中包含了端口号和IP地址。

很多IETF团体中的纯化论反对NAT的原因如下：
+ 端口号用于进程编址，而不是用于主机编址（在家庭网络中的服务器中会引起问题）
+ 路由器仅应该处理高达第三层的packet
+ 违反了端到端原则：主机彼此应该相互直接对话，节点不应该修改ip和端口号
+ 应该使用ipv6来解决地址短缺问题

NAT对P2P应用有阻碍作用，使得隐藏在NAT后边的节点不能充当服务端。但是可以通过连接反转connection reversal，就是NAT穿越NAT traversal

#### 5 UPnP

NAT穿越可以由UPnP提供，允许主机发现配置邻近NAT协议，通过在NAT上配置一条（专用IP，专用端口号）---（公用IP，公用端口号）的映射。

### 4.4.3 因特网控制报文协议 ICMP

RFC792 ICMP被主机和路由器用来彼此沟通网络层的信息。

最典型的用途是差错通告：在某个位置，IP路由器不能找到一条路径，以通往目标主机。该路由器就会向源主机创建和发出一个类型为3的ICMP报文，来指示该错误。

ICMP报文由IP承载，由一个类型字段和一个编码字段组成，并且包含引起该ICMP首次生成的IP数据报的首部和前8个字节。

ICMP类型|编码|描述
---|---|---
0|0|echo回答（对ping的回答）
3|0|目的网络不可达
3|1|目的主机不可达
3|2|目的协议不可达
3|3|目的端口不可达
3|6|目的网络未知
3|7|目的主机未知
4|0|源抑制（拥塞控制）
8|0|回显请求
9|0|路由器通告
10|0|路由器发现
11|0|TTL过期
12|0|IP首部损坏

ping程序发送一个8|0报文到目的主机，目的主机回答0|0/。

拥塞控制报文很少使用，因为TCP有自己的实现。

Traceroute使用ICMP报文实现，改程序从TTL=1的IP数据报（携带UDP报文，不可达端口号）开始发送，路径上等于这个数值的路由器，会发送一个TTL过期的报文给发送方。

到达目的主机后，由于端口不可达，那么目的主机向源主机发送端口不可达的ICMP报文。

### 4.4.4 IPv6

RFC2460

从20世纪90年代开始，因特网工程任务组 IETF 就开始致力于开发一种替代IPv4的协议，动机如下：
+ 新的子网和IP节点以惊人的增长率连接到因特网上，32bitIP地址即将用完

2011年2月，IANA想一个区域注册机构分配完了未分配的IPv4地址的最后剩余地址池。

人们最初预想ST-2协议将成为IPv5，但是ST-2最终被舍弃了。
（因特网流协议（IPv5）是一个资源协议，被称为因特网流协议(ST)，目的是提供服务质量（QoS），支持多媒体在因特网上实时传输。
需要注意的是：IPv6与IPv5无关，IPv5也已嵌入至IPv4。）

#### 1 IPv6数据报格式

![IPv6数据报格式](http://o9hjg7h8u.bkt.clouddn.com/4-24%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)

最主要变化
+ 扩大地址容量：IP地址长度从32bit增加到128bit。除了单播地址和多播地址，IPv6引入任播地址anycast address。
+ 简化高效的40字节首部：40字节定长首部允许更快地处理数据报.
+ 流标签与优先级：难以琢磨的流flow定义

字段解析：
+ 版本：4bit，值为6
+ 流量类型：8bit，类似IPv4中TOS
+ 流标签：20bit，用于标识一条数据报的流
+ 有效载荷长度：16bit，无符号整数，指跟在定长的40字节的数据报首部后面的字节数量
+ 下一个首部：标识数据报中的内容，需要交付给哪个协议（TCP，UDP等），与IPv4协议字段相同
+ 跳限制：每台路由器对该字段的内容减1， 到达0时，该数据报被丢弃。类似TTL？
+ 源地址和目的地址：在 RFC4291中描述
+ 数据

IPv4中不复存在的几个字段
+ 分片/重新组装：IPv6不允许在路由器上对数据进行分片和组装，只能在源和目的主机进行，如果一个数据报太大，那么路由器返回一个ICMP差错报文。
+ 首部校验和：因为传输层和数据链路层都执行了检验操作。因为IPv4在路由器重新设置TTL时，需要对校验和重新计算，也是一个耗时操作。
+ 选项：选项不在出现在标准头部，可能出现在下一个首部指示的位置。

RFC 4443定义了用于IPv6的ICMPv6。定义增加诸如“分组太大”，“未识别的IPv6选项”。还包含了IGMP，用于管理主机加入或者离开多播组。
IGMP在IPv4中是一个与ICMP分开的协议。

#### 2 从IPv4到IPv6的迁移

新系统可以做向后兼容，但是已经部署的IPv4却不能处理IPv6数据报。

宣布一个好日子，到时候互联网设备关机升级？不可能。

RFC 4213描述了两种可以使IPv6主机和路由器融入IPv4世界的方法。

双栈dual stack方法：
1. 运入IPv6使能节点： 使用该方法的IPv6节点，也实现了完整的IPv4功能。之间涉及很多IP头部转换，有些字段可能丢失。
2. 建立隧道tunneling：通过IPv4节点时，讲整个IPv6数据报放入数据字段。

从这些经验中学到：要改变网络层协议是及其困难的，如同在不拆掉一座房子的情况下更换基石；更换应用层协议倒是简单的一笔。

![IPv6使能节点](http://o9hjg7h8u.bkt.clouddn.com/4-25IPv6%E4%BD%BF%E8%83%BD%E8%8A%82%E7%82%B9.png)

![建立隧道](http://o9hjg7h8u.bkt.clouddn.com/4-26%E5%BB%BA%E9%9A%A7%E9%81%93.png)

### 4.4.5 涉足IP安全性

IPv4的设计是在因特网主要用于相互信任的联网研究人员之间的时代完成的。

IPsec是一种可以提供各种安全性服务的网络协议，在各种VPN中得到了广泛部署。

被设计为IPv4和IPv6兼容。IPsec仅需在两台end system中运行即可通信。

由IPsec提供的服务包括：
+ 密码技术约定：
+ IP数据报有效载荷的加密：
+ 数据完整性：
+ 初始鉴别：


## 4.5 路由选择算法

主机通常直接与一台路由器相连接，该路由器为该主机的默认路由器default router，又称为该主机的第一跳路由器first-hop router

源主机的默认路由器称为源路由器source router，目的主机的默认路由器称作目的路由器destination router。

路由选择算法的目的：给定一组路由器和路由器的链路，路由选择算法要找到一条从源路由器到目的路由器的好路径。通常指具有最低费用的路径。
+ 但是现实世界中，还有其他一些限制，诸如：组织Y的路由器不能转发来源于组织Z的packet等。

可以将路由选择问题形式化为图graph。
+ 每条路径都有一个费用，这些路径中的一条或多条是最低费用路径。
+ 具有最低费用的路径时，也需要考虑具有最少链路数量的路径。

根据算法是全局的还是分散式的区分：
+ 全局式路由选择算法：global routing algorithm 用完整的、全局性的网络知识计算出从源到目的地之间的最低费用路径。实践上称为链路状态Link State算法
+ 分散式路由选择算法：decentralized routing algorithm 没有节点拥有完整信息。一个算法称为距离向量Distance-Vector算法。

根据静态/动态分类：
+ 静态路由选择算法 static routing algorithm 随着时间流逝，路由变化速度非常缓慢，通常由人工干预调整
+ 动态路由选择算法 dynamic routing algorithm 能够根据流量负载或拓扑变化改变路由选择路径。周期性运行或者响应拓扑或链路费用的变化。
虽然易于对网络的变化做出反应，也更容易收到诸如路由选择循环、路由震荡之类问题的影响。

根据负载敏感，负载迟钝划分：
+ 负载敏感算法 load-sensitive algorithm 链路费用会动态变化以反映出底层链路的当前拥塞水平。
早期的ARPAnet路由选择算法是负载敏感的，所以遇到了很多难题。
+ 负载迟钝算法 load-insensitive algorithm 当今的因特网路由选择算法RIP，OSPF，BGP都是这种，因为链路费用不明显地反映拥塞状况。

### 4.5.1 链路状态路由选择算法 LS

通过让每个节点向网络中，所有其他节点广播链路状态分组来完成，由链路状态广播link state broadcast算法完成。
节点广播的结果是，所有节点具有了该网络的等同的、完整的视图。

参考Dijkstra 算法。或者Prim算法。参见page 266

### 4.5.2 距离向量路由选择算法 DV

迭代的、异步的、分布式的算法。

Bellman-Ford方程： d_x(y) = min_x{ c(x, v) + d_v(y) }

RIP, BGP, ISO IDRP, Novell IPX, ARPAnet都使用该算法。

LS和DV采用互补的方法来解决路由选择计算问题。

### 4.5.3 层次路由选择















